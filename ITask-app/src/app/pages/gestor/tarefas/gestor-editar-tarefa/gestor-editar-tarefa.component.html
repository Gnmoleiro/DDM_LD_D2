@if (loading$ | async){
<app-loading></app-loading>
}
@else{
    <h2 class="mb-4 text-center">Editar tarefa</h2>
    <ion-grid>
        <ion-row class="ion-align-items-center">
            <ion-col size="12" size-md="6">
            <ion-item>
                <ion-input
                placeholder="Pesquisar por título..."
                [(ngModel)]="searchTerm">
                </ion-input>
            </ion-item>
            </ion-col>
            <ion-col size="6" size-md="3">
            <ion-item>
                <ion-select label="Tipo de tarefa" placeholder="Tipo de tarefa" [(ngModel)]="filtroTipoTarefa">
                <ion-select-option value="">Todos</ion-select-option>
                @for (item of tipoTarefas; track $index) {
                    <ion-select-option
                                        [value]="item.idTipoTarefa">
                        {{item.nome}}
                    </ion-select-option>
                }
                </ion-select>
            </ion-item>
            </ion-col>
            <ion-col size="6" size-md="3">
            <ion-item>
                <ion-select label="Programador" placeholder="Programador" [(ngModel)]="filtroProgramador">
                <ion-select-option value="">Todos</ion-select-option>
                    @for (p of programadores; track p.idUser) {
                        <ion-select-option [value]="p.idUser">
                            {{p.nome}}
                        </ion-select-option>
                    }
                </ion-select>
            </ion-item>
            </ion-col>

        </ion-row>
        <ion-row class="ion-align-items-center">
            <ion-col size="6" size-md="3">
            <ion-item>
                <ion-select label="Estado da tarefa" placeholder="Estado" [(ngModel)]="filtroEstadoTarefa">
                    <ion-select-option value="">Todos</ion-select-option>
                    @for (item of estadoTarefas; track item.estadoTarefa) {
                        <ion-select-option [value]="item.estadoTarefa">
                            {{item.estadoTarefa}}
                        </ion-select-option>
                    }
                </ion-select>
            </ion-item>
            </ion-col>
        </ion-row>
    </ion-grid>

    @for (item of filteredTarefas; track item) {
        <ion-card>
            <ion-card-content>

            <ion-item lines="none">
                <ion-label>
                <h2 class="fw-bold">{{ item.tituloTarefa }}</h2>
                <p>Descrição: <strong>{{ item.descricao }}</strong></p>
                <p>Data prevista inicio: <strong>{{ item.dataPrevistaInicio }}</strong></p>
                <p>Data prevista termino: <strong>{{ item.dataPrevistaFim }}</strong></p>
                <p>Tipo de tarefa: <strong>{{ item.tipoTarefa?.nome }}</strong></p>
                <p>Estado da tarefa: <strong>{{ item.estadoTarefa }}</strong></p>
                <p>Programador atribuído: <strong>{{ item.programador?.nome }}</strong></p>
                <p>Data criação: <strong>{{ item.dataCriacao }}</strong></p>
                </ion-label>
            </ion-item>

            <div class="ion-text-end mt-2">
                <ion-button size="small" color="primary" (click)="setOpen(item)">
                Editar
                </ion-button>
            </div>

            </ion-card-content>
        </ion-card>
    }

    <ion-modal (willDismiss)="onWillDismiss($event)">
        <ng-template>
            <ion-header>
                <ion-toolbar>
                    <ion-title>Editar tarefa</ion-title>
                    <ion-buttons slot="start">
                    <ion-button (click)="cancel()">Fechar</ion-button>
                    </ion-buttons>
                    <ion-buttons slot="end">
                    <ion-button color="success" (click)="confirm()">Salvar</ion-button>
                    </ion-buttons>
                </ion-toolbar>
                </ion-header>
                <ion-content class="ion-padding">
                @if (tarefaEdit){
                <ion-list>
                    <ion-item>
                        <ion-input label="ID: " placeholder={{tarefaEdit.idTarefa}} disabled="true"></ion-input>
                    </ion-item>
                    <ion-item>
                        <ion-input label="Titulo: " placeholder={{tarefaEdit.tituloTarefa}} [(ngModel)]="tarefaEdit.tituloTarefa"></ion-input>
                    </ion-item>
                    <ion-item>
                        <ion-input label="Descrição: " placeholder={{tarefaEdit.descricao}} [(ngModel)]="tarefaEdit.descricao"></ion-input>
                    </ion-item>
                    <ion-item>
                        @if (tarefaEdit.tipoTarefa) {
                            <ion-select label="Tipo de Tarefa: " 
                            placeholder="Selecione o tipo de tarefa" name="idTipoTarefa"
                            [(ngModel)]="selectedTipoTarefaId">
                            @for (tipo of tipoTarefas; track tipo.idTipoTarefa) {
                                <ion-select-option [value]="tipo.idTipoTarefa">{{tipo.nome}}</ion-select-option>
                            }
                        </ion-select>
                        }
                    </ion-item>
                    <ion-item>
                        @if (tarefaEdit.programador) {
                            <ion-select label="Programador: " 
                            placeholder="Selecione o programador" name="idUser"
                            [(ngModel)]="selectedProgramadorId">
                            @for (programador of programadores; track programador.idUser) {
                                <ion-select-option [value]="programador.idUser">{{programador.nome}}</ion-select-option>
                            }
                        </ion-select>
                        }
                    </ion-item>
                    <ion-item>
                        @if (tarefaEdit.estadoTarefa) {
                            <ion-select label="Estado: " 
                            placeholder="Selecione o estado" name="idEstadoTarefa"
                            [(ngModel)]="selectedEstadoTarefa">
                            @for (estado of estadoTarefas; track estado.estadoTarefa) {
                                <ion-select-option [value]="estado.estadoTarefa">{{estado.estadoTarefa}}</ion-select-option>
                            }
                        </ion-select>
                        }
                    </ion-item>
                    <ion-item>
                        <ion-input label="Data Prevista Início: " placeholder={{tarefaEdit.dataPrevistaInicio}} 
                        [(ngModel)]="tarefaEdit.dataPrevistaInicio" type="date"></ion-input>
                    </ion-item>
                    <ion-item>
                        <ion-input label="Data Prevista Fim: " placeholder={{tarefaEdit.dataPrevistaFim}} 
                        [(ngModel)]="tarefaEdit.dataPrevistaFim" type="date"></ion-input>
                    </ion-item>
                </ion-list>
                }
            </ion-content>
        </ng-template>
    </ion-modal>
}